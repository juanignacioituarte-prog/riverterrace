<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Farm Monitor – Latest Sync</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
html, body {
    height: 100%;
    margin: 0;
}

body {
    display: flex;
    font-family: system-ui, sans-serif;
    background: #f4f7f6;
}

#map {
    flex: 1;
    height: 100%;
}

#sidebar {
    width: 350px;
    background: #fff;
    border-left: 1px solid #ddd;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #eee;
}

.avg-card {
    background: #27ae60;
    color: #fff;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 12px;
}

#list {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
}

.card {
    background: #fff;
    border: 1px solid #eee;
    border-left: 5px solid #27ae60;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
}

.row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    margin-top: 4px;
}

#dimmer {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    z-index: 999;
    box-shadow: 0 4px 10px rgba(0,0,0,.15);
}
</style>
</head>

<body>

<div id="map"></div>

<div id="dimmer">
<b style="font-size:11px;">NDVI OPACITY</b><br>
<input type="range" id="opac" min="0" max="1" step="0.1" value="0.7">
</div>

<div id="sidebar">
    <div class="sidebar-header">
        <div class="avg-card">
            <div style="font-size:11px;">LATEST FARM AVG</div>
            <div id="total-avg" style="font-size:28px;font-weight:bold;">–</div>
        </div>
        <input id="search" placeholder="Filter paddocks…" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div id="list"></div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=0&single=true&output=csv";

let map, ndviLayer;
let latestData = [];

function initMap() {
    map = L.map('map').setView([-42.6794, 172.8791], 14);

    L.tileLayer(
        'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
        { maxZoom: 20 }
    ).addTo(map);

    document.getElementById('opac').oninput = e => {
        if (ndviLayer) ndviLayer.setOpacity(e.target.value);
    };
}

function parseNDVI(r) {
    return parseFloat(
        r.ndvi_effective ??
        r.ndvi ??
        r.ndvi_mean ??
        r.ndvi_avg
    ) || 0;
}

function parseDate(d) {
    const t = new Date(d).getTime();
    return isNaN(t) ? 0 : t;
}

function loadCSV() {
    Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => {
            console.log("ROWS LOADED:", res.data.length);

            const best = {};

            res.data.forEach(r => {
                if (!r.paddock_name) return;

                const score = parseDate(r.date_utc || r.date);
                if (!best[r.paddock_name] || score > best[r.paddock_name].score) {
                    best[r.paddock_name] = {
                        name: r.paddock_name,
                        date: r.date_utc || r.date || "–",
                        ndvi: parseNDVI(r),
                        url: (r.map_id || "").trim(),
                        score
                    };
                }
            });

            latestData = Object.values(best).sort((a,b)=>b.ndvi-a.ndvi);

            if (latestData.length) {
                const avg = latestData.reduce((s,p)=>s+p.ndvi,0)/latestData.length;
                document.getElementById("total-avg").innerText = avg.toFixed(3);
            } else {
                document.getElementById("total-avg").innerText = "NO DATA";
            }

            render("");
        }
    });
}

function render(term) {
    const list = document.getElementById("list");
    list.innerHTML = "";

    latestData
        .filter(p => p.name.toLowerCase().includes(term.toLowerCase()))
        .forEach(p => {
            const c = document.createElement("div");
            c.className = "card";
            c.innerHTML = `
                <div class="row"><b>${p.name}</b><small>${p.date}</small></div>
                <div class="row"><span>NDVI</span><b>${p.ndvi.toFixed(3)}</b></div>
            `;
            c.onclick = () => loadNDVI(p.url);
            list.appendChild(c);
        });
}

function loadNDVI(url) {
    if (!url || !url.includes("{z}")) {
        alert("No tile-based NDVI map for this paddock.");
        return;
    }
    if (ndviLayer) map.removeLayer(ndviLayer);

    ndviLayer = L.tileLayer(url, {
        opacity: document.getElementById("opac").value
    }).addTo(map);
}

initMap();
loadCSV();
document.getElementById("search").oninput = e => render(e.target.value);
</script>

</body>
</html>
